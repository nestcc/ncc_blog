# 总体过程



1. 按电源后BIOS开始工作， 然后进行加点自检。
2. MBR引导
3. 启动内核
4. 启动init进程



# BIOS



## 微控制器

系统想要启动必须先加在BIOS。按下电源时，给微控制器下达一条复位指令，各寄存器复位，最后下达一条跳转指令，跳转到BIOS的ROM，使得硬盘去读取主板上的BIOS程序。



## BIOS => POST

随后BIOS程序加载CMOS（可读写的RAM芯片，保存BIOS设置硬件参数的数据）的信息，**借CMOS取得主机的各项硬件配置**。

之后BIOS进行加电自检过程（Power-on Self Test, POST），检测计算机各种硬件信息，若发现硬件错误则会报错。

之后BIOS对硬件进行初始化。

BIOS将自己复制到物理内存中继续执行，开始按顺序搜寻可引导存储设备。接下来就会读取磁盘的内容，这时需要一个不依赖文件系统的方法是的BIOS读取磁盘内容，这种方法就是引入MBR。最后BIOS读取第一个可引导的存储设备的MBR中的boot loader。将MBR加载到物理内存中执行。

MBR载入内存后，BIOS将控制权转交给MBR（MBR中的boot loader），然后MBR接管任务开始执行。





# MBR引导

>主引导记录MBR (Main Boot Record)， 是位于磁盘最前边的一段引导代码 (Loader) ，负责磁盘操作系统对磁盘进行读写时分区合法性的判别、分区引导信息的定位。它是由磁盘操作系统在对硬盘进行初始化时产生的。



在载入了第一个可引导的存储设备的MBR后，MBR中的boot loader就要读取所在磁盘的操作系统核心文件（即内核文件）。



## boot loader

不同的操作系统文件格式不同，并且有点时候我们会在一个磁盘上安装多个操作系统，所以boot loader的功能是远远不够的。因此我们需要一个相对应的程序来处理各自操作系统的内核，这个程序就是操作系统的loader。这样boot loader只需要将控制权交给操作系统的loader，就可以让它去启动操作系统了。

boot loader 完成2  个工作：

1. 提供选单
   让用户决定进入哪一个系统 

2. 直接读取内核

3. 转交其他操作系统的loader

   当用户选择其他操作系统时，boot loader会将控制权交给相对应的loader。



##  GRUB

Linux的loader时grub。

**grub拥有在不依赖Linux内核的情况下读取文件与内核映像的能力。**

在`/boot/grub/`中存放这grub的相应文件。

如果默认是Linux启动，则需要把stage1文件加载到MBR中，该文件很小，因此只起到引用的作用。

stage1完成了主程序的引导后，主引用程序开始加载配置文件。grub的内置文件系统是依靠stage1_5这些文件定义的，不同文件系统有着不同的stage1_5。

之后真正开始读取配置文件的是stage2，它读取并解析grub.conf文件。



**总结：MBR最核心的作用就是加载内核文件**



# 启动内核



## 加载内核文件

MBR将内核文件载入内存中运行，内核就是`/boot/`中的`vmlinuz-xxx`文件，这是一个压缩的镜像文件。

控制权转交给内核之后，内核会重新检测各种硬件信息，还会加载内核各个程序功能的模块。但这里存在一个问题：想要加载模块就需要挂载根目录，想要挂载根目录就需要有文件系统的支持，但此时还没有加载各个模块，所以如何加载模块就成为了一个问题。



## 加载initrd初始化ramfs文件系统

内核会先展开`/boot/initramfs-xxx.img`这个文件，形成一个虚拟文件系统，内核借助虚拟文件系统装载必要的模块，完成后释放该虚拟文件系统。





# 启动第一个进程init



## init进程：主要功能是准备软件执行环境



内核完成硬件检测和加载模块后，内核会呼叫第一个进程`/sbin/ini`，至此内核吧控制权交给init进程读取初始化配置文件`/etc/inittab`，决定操作系统的runlevel。



## /etc/rc.d/rc.sysinit

读取`/etc/rc.d/rc.sysinit`系统初始化脚本，设置主机名，挂载`/etc/fstab`中的文件系统，修改`/etc/sysctl.conf`的内核参数等各项系统环境。



## /etc/rc.d/rc

执行`/etc/rc.d/rc`脚本。

根据`runlevel`(0, 1, ... ,6) 进入相应的`/etc/rc.d/rcN.d/`目录，启动和关闭相应的系统服务





## /etc/rc.d/rc.local

系统根据`runlevel`执行完`/etc/rc.d/rcN.d`中的脚本后，调用`/etc/rc.d/rc.local`脚本。

这时系统已经完成了各种必要系统服务的启动，**如果我们想定义一些指令要在开机时自动启动，我们就可以吧它们放到`/etc/rc.d/rc.local`内，该文件默认为空。**



## 启动终端

接下来由`/sbin/mingtty`指令启动终端，由于系统设置启动tty1-tty6，所以会启动6个命令行终端。

